---
title: "Mapping Other C&I Projects"
format: 
  html:
    toc: true
    toc-location: left
    fig-cap-location: margin
    tbl-cap-location: margin
    code-fold: true
---

```{r}
#| output: false
#| code-fold: false

library(tidyverse)
library(sf)
library(DBI)
library(ptaxsim)
library(ggplot2)


comm_ind <- read_csv("Output/comm_ind_PINs_2011to2022_timeseries.csv") %>% 
  filter(year == 2022) |> 
  select(-year)

geo_names <- comm_ind |> select(pin, clean_name, Triad, Township)

exists_in2022 <- comm_ind |> filter(class_1dig %in% c(5,6,7,8)) |> select(pin, class)
write_csv(exists_in2022, "Output/CIpins_in2022_deleteaftermerge.csv")
```

```{r}
# #| warning: false
# #| message: false

ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2023.0.0.db")
```


```{r}
#| eval: false

# ptax_pins <- read_csv("./Output/Dont_Upload/0_joined_PIN_data_2022.csv") %>%
#   mutate(class = as.numeric(class))




# we use buyer name for creating groups in later chunks
sales <- read_csv("../../dissertation/data/raw/Assessor_-_Parcel_Sales_20250709.csv") %>% 
#sales <- read_csv("../../dissertation/data/raw/Assessor_Parcel_Sales_20250105.csv") %>% 
 # "./inputs/Assessor_-_Parcel_Sales_20250704.csv") %>%
  filter(class > 399 & class < 900) %>%
  mutate(major_class = str_sub(class, 1, 1),
            pin10 = str_sub(pin,1,10)) |>
  mutate(incent_prop = ifelse(as.numeric(class) > 599, 1, 0) # already filtered to less than 900 level properties above
         )

pins_sold <- sales %>% 
  group_by(pin) %>% 
  arrange(desc(year)) %>%
  summarize(year_sold = max(year),
            class_current = first(class),
            sale_document_num= first(sale_document_num),
            sale_buyer_name = first(sale_buyer_name), 
            num_parcels_sale = first(num_parcels_sale)) 

parcels_sold <- sales %>% 
  group_by(pin10) %>% 
  arrange(desc(year)) %>%
  summarize(sale_document_num= first(sale_document_num),
            sale_buyer_name = first(sale_buyer_name), 
            num_parcels_sale = first(num_parcels_sale),
            incent_prop_pct = mean(incent_prop, na.rm=TRUE),
            max_proj_class = max(class))


keypins <- read_csv("./Output/keypins_from_methodwkshts.csv") |>
  mutate(
    keypin = ifelse(keypin == "amazon", "28242010220000", keypin)
                  )
```


```{r}
#| label: read-BOR-data
#| eval: false

bor <- read_csv("Output/borappeals.csv") 
# %>%
#   mutate(project_appellant = paste(project_id, sep = "-", appellant),
#          pin10 = str_sub(pin,1,10),
#          incent_prop = ifelse(as.numeric(class) > 599 & as.numeric(class) < 900, 1, 0)) 


```


```{r}
#| label: writecsv-projectcheck
#| eval: false

bor_pins <- bor %>%
  group_by(pin) %>%
  arrange(desc(tax_year)) %>%
  summarize(
    year_appealed_mostrecent = max(tax_year),
    class_bor_mostrecent = first(class),
    appellant = first(appellant),
    project_id = first(project_id),
    timesappealed = n() ) %>%
  mutate(proj_appeallant = paste(project_id, "-", appellant)) 



keypincheck <- comm_ind |>
  left_join(keypins, by = "pin") |>
  left_join(bor_pins, by = "pin") |>
  left_join(pins_sold, by = "pin")

keypincheck[keypincheck=="NA"] <- NA

keypincheck <- keypincheck |>
    mutate(pin10=str_sub(pin,1,10),
           pin7 = str_sub(pin, 1, 7))|>
  select(pin, pin10, pin7, keypin, sale_buyer_name, sale_document_num,
         num_parcels_sale, year_sold,  proj_appeallant, timesappealed,
         incent_prop, appellant, appealid = project_id, year_appealed_mostrecent, class_bor_mostrecent, class_ptaxsim = class, class, class_sales = class_current) #|>

# commented this out because I wanted to see what keypins were included in original methodology worksheets
  # mutate(keypin = ifelse(is.na(keypin), pin, keypin))

keypincheck <- keypincheck |> left_join(geo_names)


writexl::write_xlsx(keypincheck, "Output/project_check4.xlsx")
```

```{r}

merged_data <- readxl::read_xlsx("Output/project_check4.xlsx") |>
#  merged_data <- readxl::read_xlsx("Output/project_check3.xlsx") |>

  mutate(pin = str_pad(pin, 14, side = "left", pad = "0"),
         keypin = str_pad(keypin, 14, side = "left", pad = "0"),
         pin10 = str_sub(pin, 1, 10),
         pin7 = str_sub(pin, 1, 7))

manually_checked <- readxl::read_xlsx("Output/Pin to Project Files/projects_combined_with_municipality.xlsx", col_types = "text")|>
  mutate(pin = str_pad(pin, 14, side = "left", pad = "0"),
         keypin = str_pad(keypin, 14, side = "left", pad = "0")) |> 
  select(pin, keypin, manually_added)

merged_data2 <- full_join(merged_data, manually_checked, by = "pin")

merged_data2 <- merged_data2 |>
  mutate(main_keypin = ifelse(is.na(keypin.y), keypin.x, keypin.y))

merged_data2 <- merged_data2 |> select(pin, main_keypin, manually_added, Township, class_ptaxsim, everything())  |> select(-c(keypin.x, keypin.y))

# merged_data2 |> writexl::write_xlsx("Output/projects_checked_MAINFILE.xlsx")

```

```{r warning=FALSE, message=FALSE}
# keypins <- readxl::read_xlsx("Output/project_check_AWMmanualcheck.xlsx")

keypins <- readxl::read_xlsx("Output/project_check2.xlsx") 
 
```

- Random parcels that should be grouped in a project:
  - 0821202023, 0821202024. Share buyer name but not document number. CMAP landuse development site confirms that it is a project and developer is Bridge Point LLC
  




# Mapping Areas



## Bedford Park



```{r}
#| label: fig-parceloutlines
#| fig-cap: "parcel outlines"

twnshp_test <- comm_ind %>% 
  filter(clean_name == "Bedford Park") %>%
  mutate(pin10 = str_sub(pin, 1, 10))


pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}



## Commercial Properties in Berwyn
ggplot(parcels) +
  geom_sf() +
  theme_minimal() + theme(legend.position = "none")

```

### By Sale document number


```{r}
#| label: fig-saledocuments
#| fig-cap: "Grouped by Sale Document Number."
#| layout-ncol: 2


keypins |> filter(pin10%in% twnshp_test$pin10)

parcel_comparison <- left_join(parcels, keypins, by = "pin10", relationship = "many-to-many") %>% 
  select(pin10, everything())


parcel_comparison %>% 
  as.data.frame() |>
  group_by(sale_document_num) %>%
  summarize(parcels_ingroup = n(), 
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(incent_pins), desc(parcels_ingroup))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num, )) +
  scale_fill_continuous(na.value = "white")+
  theme_void() + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on the sale document number.

There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.




### By Buyer Name

```{r}
#| label: fig-buyernames
#| fig-cap: "Brings in buyer names from sales data. Fill color based on Buyer Name"
#| layout-ncol: 2

parcel_comparison %>% 
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(parcels_ingroup = n(), 
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(parcels_ingroup))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
    scale_fill_discrete(na.value = "white")+

  theme_void() + 
  theme(legend.position = "none")
```


There are `r paste(parcel_comparison %>% as.data.frame() |> group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 parcel in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### Board of Review

```{r}
#| label: fig-muni1-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2


parcel_comparison %>% 
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n_distinct(pin), 
            parcels = n_distinct(pin10),
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(appellant) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.


### Commercial valuation keypins

```{r}
#| label: fig-muni1-keypin
#| fig-cap: "Mapped by Commercial valuation keypin"
#| layout-ncol: 2

parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) |>
  summarize(#n=n(),
                        #parcels = n_distinct(pin10),
                        incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(incent_pins))


parcel_comparison %>% 
  ggplot() +
  geom_sf(aes(fill = as.factor(keypin))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```

```{r}
#write_csv(parcel_comparison, "Output/projects_bedfordpark.csv")
```

```{r}
parcel_comparison <- readxl::read_xlsx("Output/Pin to Project Files/projects_bedfordpark_checked.xlsx")  |>
  mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, "left", "0"))

parcel_comparison <- left_join(parcels, parcel_comparison, by = "pin10") %>% 
  select(pin10, keypin, everything()) 

parcel_comparison |>
  as.data.frame() |>
  group_by(keypin) |>
  summarize(n = n(),
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(n))

parcel_comparison %>% 
  group_by(keypin) |>
  mutate(appealid = first(appealid)) |>
    mutate(mapid = str_c(appealid, "-", keypin)) |>
  ggplot() +
  geom_sf(aes(fill = mapid)) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white")+
  theme(legend.position = "none")
```




There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manually grouped keypins from combined data sources.

```{r}
pin_info <- comm_ind |> inner_join(parcel_comparison)

pin_info |>   filter(!is.na(keypin) & !is.na(class)) |>
group_by(class) |> summarize(pins = n(),
                                         keypins = n_distinct(keypin))

pin_info |> 
  filter(!is.na(keypin)) |>
  group_by(keypin) |> 
  summarize(n = n(),
            #av_mailed = sum(av_mailed, na.rm=TRUE),
            #av_clerk = sum(av_clerk, na.rm=TRUE),
            fmv = sum(fmv, na.rm=TRUE),
            incentive_pins = sum(incent),
            exempt = sum(exempt)
            ) |>
  arrange(desc(incentive_pins))

```


## South Holland


```{r}
#| label: fig-touchespin-SH
#| fig-cap: "All commercial properties."


twnshp_test <- comm_ind %>% 
  filter(clean_name == "South Holland") %>%
  mutate(pin10 = str_sub(pin, 1, 10))


pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}


ggplot(parcels) +
  geom_sf(aes()) +
  theme_void() + theme(legend.position = "none")

```

### BOR Appeals IDs


```{r}
#| label: fig-muni-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2

parcel_comparison <- left_join(parcels, keypins) %>%
  select(pin10, appellant, everything())


parcel_comparison |>
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |> 
  arrange(desc(incent_pins), desc(pins_ingroup)) 

parcel_comparison %>% 
  group_by(appellant) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.

There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.



### By Buyer Name from Sales Data


```{r}
#| label: fig-muni-buyername
#| fig-cap: "Mapped by Buyer's name."
#| layout-ncol: 2


parcel_comparison  |>
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |>
  arrange(desc(incent_pins), desc(pins_ingroup))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
  scale_fill_discrete(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### By Sale Document Number 

```{r}
#| label: fig-muni-documentnum
#| fig-cap: "Mapped by sale document."
#| layout-ncol: 2

parcel_comparison |>
  as.data.frame() |>
  group_by(sale_document_num) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == 1, na.rm=TRUE)) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num)) +
  scale_fill_continuous(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_document_num) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_document_num) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.


### Commercial valuation keypins

```{r}
#| label: fig-muni2-keypin
#| fig-cap: "Mapped by Commercial valuation keypin"
#| layout-ncol: 2


parcel_comparison %>% 
  
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>% 
  # group_by(keypin) %>%
  # mutate(pins_ingroup = n()) %>%
  # filter(pins_ingroup > 1) |>
  ggplot() +
  geom_sf(aes(fill = as.factor(keypin))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall.

```{r}
# write_csv(parcel_comparison, "Output/projects_southholland.csv")
```

```{r}
parcel_comparison <- readxl::read_xlsx("Output/Pin to Project Files/projects_southholland_checked.xlsx")  |>
  mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, "left", "0"))

parcel_comparison <- left_join(parcels, parcel_comparison, by = "pin10") %>% 
  select(pin10, keypin, everything()) 

parcel_comparison |>
  as.data.frame() |>
  group_by(keypin) |>
  summarize(n = n(),
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(n))

parcel_comparison %>% 
  group_by(keypin) |>
  mutate(appealid = first(appealid)) |>
    mutate(mapid = str_c(appealid, "-", keypin)) |>
  ggplot() +
  geom_sf(aes(fill = mapid)) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white")+
  theme(legend.position = "none")
```


There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manually grouped keypins from combined data sources.

```{r}
pin_info <- comm_ind |> inner_join(parcel_comparison)

pin_info |>   filter(!is.na(keypin) & !is.na(class)) |>
group_by(class) |> summarize(pins = n(),
                                         keypins = n_distinct(keypin))

pin_info |> 
  filter(!is.na(keypin)) |>
  group_by(keypin) |> 
  summarize(n = n(),
            #av_mailed = sum(av_mailed, na.rm=TRUE),
            #av_clerk = sum(av_clerk, na.rm=TRUE),
            fmv = sum(fmv, na.rm=TRUE),
            incentive_pins = sum(incent),
            exempt = sum(exempt)
            ) |>
  arrange(desc(incentive_pins))

```


## Franklin Park


```{r}
#| label: fig-touchespin-FP
#| fig-cap: "All commercial properties."


twnshp_test <- comm_ind %>% 
  filter(clean_name == "Franklin Park") %>%
  mutate(pin10 = str_sub(pin, 1, 10))


pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}


ggplot(parcels) +
  geom_sf(aes()) +
  theme_void() + 
  theme(legend.position = "none")

```

### BOR Appeals IDs


```{r}
#| label: fig-muni3-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2


 parcel_comparison <- left_join(parcels, keypins) %>%
   select(pin10, appellant, everything())

parcel_comparison |>
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive", na.rm=TRUE)) |> 
  arrange(desc(pins_ingroup), desc(incent_pins)) 

parcel_comparison %>% 
  group_by(appellant) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.

There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.




### By Buyer Name from Sales Data


```{r}
#| label: fig-muni3-buyername
#| fig-cap: "Mapped by Buyer's name."
#| layout-ncol: 2


parcel_comparison  |>
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
  scale_fill_discrete(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### By Sale Document Number 

```{r}
#| label: fig-muni3-documentnum
#| fig-cap: "Mapped by sale document."
#| layout-ncol: 2

parcel_comparison |>
  as.data.frame() |>
  group_by(sale_document_num) %>%
  summarize(pins_ingroup = n(),
            parcels_ingroup = n_distinct(pin10),
            incent_pins = sum(incent_prop =="Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num)) +
  scale_fill_continuous(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.


### Commercial valuation keypins

```{r}
#| label: fig-muni3-keypin
#| fig-cap: "Mapped by Commercial valuation keypin. Only shows projects that had at least 1 parcel in it"
#| layout-ncol: 2


parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n(),
            incent_prop = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>%
  filter(n() > 1, .by = keypin) |>
  ggplot() +
  geom_sf(aes(fill =keypin)) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.

```{r}
write_csv(parcel_comparison, "Output/projects_franklinpark.csv")
```

```{r}
parcel_comparison <- readxl::read_xlsx("Output/Pin to Project Files/projects_franklinpark_checked.xlsx")  |>
  mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, "left", "0"))

parcel_comparison <- left_join(parcels, parcel_comparison, by = "pin10") %>% 
  select(pin10, keypin, everything()) 

parcel_comparison |>
  as.data.frame() |>
  group_by(keypin) |>
  summarize(n = n(),
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(n))

parcel_comparison %>% 
  group_by(keypin) |>
  mutate(appealid = first(appealid)) |>
    mutate(mapid = str_c(appealid, "-", keypin)) |>
  ggplot() +
  geom_sf(aes(fill = mapid)) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white")+
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manually grouped keypins from combined data sources.

```{r}
pin_info <- comm_ind |> inner_join(parcel_comparison)

pin_info |>   filter(!is.na(keypin) & !is.na(class)) |>
group_by(class) |> summarize(pins = n(),
                                         keypins = n_distinct(keypin))

pin_info |> 
  filter(!is.na(keypin)) |>
  group_by(keypin) |> 
  summarize(n = n(),
            #av_mailed = sum(av_mailed, na.rm=TRUE),
            #av_clerk = sum(av_clerk, na.rm=TRUE),
            fmv = sum(fmv, na.rm=TRUE),
            incentive_pins = sum(incent),
            exempt = sum(exempt)
            ) |>
  arrange(desc(incentive_pins))

```


## Matteson


```{r}
#| label: fig-touchespin-Mat
#| fig-cap: "All commercial properties."


twnshp_test <- comm_ind %>% 
  filter(clean_name == "Matteson") %>%
  mutate(pin10 = str_sub(pin, 1, 10))


pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}


ggplot(parcels) +
  geom_sf(aes()) +
  theme_void() + 
  theme(legend.position = "none")

```

### BOR Appeals IDs


```{r}
#| label: fig-muni4-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2


 parcel_comparison <- left_join(parcels, keypins) %>%
   select(pin10, appellant, everything())

parcel_comparison |>
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive", na.rm=TRUE)) |> 
  arrange(desc(pins_ingroup), desc(incent_pins)) 

parcel_comparison %>% 
  group_by(appellant) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.


There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.



### By Buyer Name from Sales Data


```{r}
#| label: fig-muni4-buyername
#| fig-cap: "Mapped by Buyer's name."
#| layout-ncol: 2


parcel_comparison  |>
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
  scale_fill_discrete(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### By Sale Document Number 

```{r}
#| label: fig-muni4-documentnum
#| fig-cap: "Mapped by sale document."
#| layout-ncol: 2

parcel_comparison |>
  as.data.frame() |>
  group_by(sale_document_num) %>%
  summarize(pins_ingroup = n(),
            parcels_ingroup = n_distinct(pin10),
            incent_pins = sum(incent_prop =="Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num)) +
  scale_fill_continuous(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### Commercial valuation keypins

```{r}
#| label: fig-muni4-keypin
#| fig-cap: "Mapped by Commercial valuation keypin. Only shows projects that had at least 1 parcel in it"
#| layout-ncol: 2

parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n(),
            incent_prop = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>%
  filter(n() > 1, .by = keypin) |>
  ggplot() +
  geom_sf(aes(fill =keypin)) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```


There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.

```{r}
# write_csv(parcel_comparison, "Output/projects_matteson.csv")
```


```{r}
parcel_comparison <- readxl::read_xlsx("Output/Pin to Project Files/projects_matteson_checked.xlsx")  |>
  mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, "left", "0"))

parcel_comparison <- left_join(parcels, parcel_comparison, by = "pin10") %>% 
  select(pin10, keypin, everything()) 

parcel_comparison |>
  as.data.frame() |>
  group_by(keypin) |>
  summarize(n = n(),
            incent_pins = sum(incent_prop=="Incentive")) |>
  arrange(desc(n))

parcel_comparison %>% 
  group_by(keypin) |>
  mutate(appealid = first(appealid)) |>
    mutate(mapid = str_c(appealid, "-", keypin)) |>
  ggplot() +
  geom_sf(aes(fill = mapid)) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white")+
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manual keypins.


## Elk Grove Village


```{r}
#| label: fig-touchespin-EGV
#| fig-cap: "All commercial properties."


twnshp_test <- comm_ind %>% 
  filter(clean_name == "Elk Grove Village") %>%
  mutate(pin10 = str_sub(pin, 1, 10))


pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}

ggplot(parcels) +
  geom_sf(aes()) +
  theme_void() + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.


### BOR Appeals IDs


```{r}
#| label: fig-muni5-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2

 parcel_comparison <- left_join(parcels, keypins) %>%
   select(pin10, appellant, everything())

parcel_comparison |>
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive", na.rm=TRUE)) |> 
  arrange(desc(pins_ingroup), desc(incent_pins)) 

parcel_comparison %>% 
  group_by(appellant) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.

There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.



### By Buyer Name from Sales Data


```{r}
#| label: fig-muni5-buyername
#| fig-cap: "Mapped by Buyer's name."
#| layout-ncol: 2


parcel_comparison  |>
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(pins_ingroup = n(),
            incent_pins = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
  scale_fill_discrete(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### By Sale Document Number 

```{r}
#| label: fig-muni5-documentnum
#| fig-cap: "Mapped by sale document."
#| layout-ncol: 2

parcel_comparison |>
  as.data.frame() |>
  group_by(sale_document_num) %>%
  summarize(pins_ingroup = n(),
            parcels_ingroup = n_distinct(pin10),
            incent_pins = sum(incent_prop =="Incentive")) |>
  arrange(desc(pins_ingroup), desc(incent_pins))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num)) +
  scale_fill_continuous(na.value = "white" ) + 
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_document_num) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_document_num) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### Commercial valuation keypins

```{r}
#| label: fig-muni5-keypin
#| fig-cap: "Mapped by Commercial valuation keypin. Only shows projects that had at least 1 parcel in it"
#| layout-ncol: 2


parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n(),
            incent_prop = sum(incent_prop == "Incentive")) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>%
  filter(n() > 1, .by = keypin) |>
  ggplot() +
  geom_sf(aes(fill =keypin)) +
  theme_void() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on ommrial valuation worksht kypins. 



```{r}
#| label: fig-muni2-checkedprojects
#| fig-cap: "Mapped by Commercial valuation keypin"
#| layout-ncol: 2

keypins_checked <- readxl::read_xlsx("Output/Pin to Project Files/projects_elkgrove_checked.xlsx") |>
  mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, side = "left", pad = "0"))
parcel_comparison <- left_join(parcels, keypins_checked, by = "pin10") %>% 
  select(pin10, keypin, everything()) 


parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n()) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>% 
  group_by(keypin) %>%
  mutate(pins_ingroup = n()) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(keypin))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manual group keypins.


## Berwyn

```{r}
#| label: fig-touchingpins
#| fig-cap: "Loop creates `group` id for connected parcels. Mapped by if a parcel is touching another parcel. Simply touching another parcel is not how we want to create project IDs, but it does allow a quick visualization to see if there are PINs nested inside of other PINs which would indicate a larger project shared by the same owner. **This mapping method is mostly just a stepping stone for comparison.**"

twnshp_test <- comm_ind %>% 
  filter(Township == "Berwyn") %>%
  mutate(pin10 = str_sub(pin, 1, 10))

pins_geo <- lookup_pin10_geometry(year = 2022, 
                                        pin10 = twnshp_test$pin10) %>%
  st_as_sf(wkt = "geometry", crs = 4326)

points <- st_as_sf(pins_geo, coords = c("longitude", "latitude"), crs = 4326)

parcels <- st_as_sf(pins_geo, wkt = "geometry", crs = 4326)

invalid_geom <- st_is_valid(parcels)
table(invalid_geom)
parcels$geometry <- st_make_valid(parcels$geometry)

# Filter out invalid geometries
parcels <- parcels[st_is_valid(parcels), ]

neighbors <- st_touches(parcels)
parcels$group <- rep(NA, nrow(parcels))

group_id <- 1  # Start with the first group ID

# Loop over each parcel
for (i in seq_along(neighbors)) {
  if (is.na(parcels$group[i])) {  # If the parcel hasn't been assigned to a group yet
    
    # Start a list of parcels to visit (start with the current parcel)
    to_visit <- i
    
    # Use BFS/DFS to explore connected parcels and assign the same group ID
    while (length(to_visit) > 0) {
      current <- to_visit[1]  # Get the first parcel to visit
      to_visit <- to_visit[-1]  # Remove it from the list
      
      if (is.na(parcels$group[current])) {  # If the parcel hasn't been visited
        parcels$group[current] <- group_id  # Assign the current group ID
        
        # Add its neighbors (parcels it touches) to the list of parcels to visit
        to_visit <- c(to_visit, neighbors[[current]])
      }
    }
    
    # Increment the group ID for the next group of connected parcels
    group_id <- group_id + 1
  }
}



## Commercial Properties in Berwyn
ggplot(parcels) +
  geom_sf(aes()) +
  theme_minimal() + theme(legend.position = "none")

```


### Commercial valuation keypins

```{r}
#| label: fig-muni6-keypin
#| fig-cap: "Mapped by Commercial valuation keypin"
#| layout-ncol: 2

parcel_comparison <- left_join(parcels, keypins) %>% 
  select(group, pin10, keypin, everything()) 


parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n()) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>% 
  group_by(keypin) %>%
  mutate(pins_ingroup = n()) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(keypin))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```


```{r}
#| label: fig-muni6-keypin-checked
#| fig-cap: "Mapped by Commercial valuation keypin"
#| layout-ncol: 2


keypins_checked <- readxl::read_xlsx("Output/Pin to Project Files/projects_berwyn_checked.xlsx") |>
    mutate(pin10 = str_pad(pin10, 10, "left", "0"),
         pin = str_pad(pin, 14, "left", "0"),
         keypin = str_pad(keypin, 14, side = "left", pad = "0"))

parcel_comparison <- left_join(parcels, keypins_checked, by = "pin10") %>% 
  select(pin10, keypin, everything()) 


parcel_comparison %>% 
  as.data.frame() |>
  group_by(keypin) %>%
  summarize(pins_ingroup = n()) |>
  arrange(desc(pins_ingroup))


parcel_comparison %>% 
  group_by(keypin) %>%
  mutate(pins_ingroup = n()) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(keypin))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")
```


There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on manually grouped keypins.

There are `r paste(parcel_comparison %>% group_by(pin) %>% n_distinct())` PINs that were C & I class for at least 1 year in the data.

```{r}
pin_info <- comm_ind |> inner_join(parcel_comparison)

pin_info |>   filter(!is.na(keypin) & !is.na(class)) |>
group_by(class) |> summarize(pins = n(),
                                         keypins = n_distinct(keypin))

pin_info |> 
  filter(!is.na(keypin)) |>
  group_by(keypin) |> 
  summarize(n = n(),
            #av_mailed = sum(av_mailed, na.rm=TRUE),
            #av_clerk = sum(av_clerk, na.rm=TRUE),
            fmv = sum(fmv, na.rm=TRUE),
            incentive_pins = sum(incent),
            exempt = sum(exempt)
            ) |>
  arrange(desc(incentive_pins))

```


### By Sale document number


```{r}
#| label: fig-muni6-saledocuments
#| fig-cap: "Grouped by Sale Document Number."
#| layout-ncol: 2

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  summarize(pins_ingroup = n(), 
            incent_pins = sum(incent_prop==1, na.rm=TRUE)) |>
  arrange(desc(incent_pins), desc(pins_ingroup))

parcel_comparison %>% 
  group_by(sale_document_num) %>%
  ggplot() +
  geom_sf(aes(fill = sale_document_num, )) +
  scale_fill_continuous(na.value = "white")+
  theme_void() + 
  theme(legend.position = "none")
```

```{r}
#| label: fig-muni6-saledocandtouches
#| fig-cap: "Default group is from saledocument. If missing sale document id, then the ID uses the group variable for if a PIN touches other PINs. Color fill uses the created ID."
#| eval: false
#| include: false

parcel_comparison %>% 
  group_by(sale_document_num, group) %>%
  mutate(pins_ingroup = n(),
         id = ifelse(is.na(sale_document_num), as.character(group), paste(sale_document_num, "_", group))) %>%
  filter(pins_ingroup > 1) %>%
  ggplot() +
  geom_sf(aes(fill = id)) +
  theme_minimal() + theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(sale_buyer_name) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.



### By Buyer Name

```{r}
#| label: fig-muni6-buyernames
#| fig-cap: "Brings in buyer names from sales data. Fill color based on Buyer Name"
#| layout-ncol: 2

parcel_comparison %>% 
  as.data.frame() |>
  group_by(sale_buyer_name) %>%
  summarize(pins_ingroup = n(), 
            incent_pins = sum(incent_prop==1)) |>
  arrange(desc(pins_ingroup))

parcel_comparison %>% 
  group_by(sale_buyer_name) %>%
  ggplot() +
  geom_sf(aes(fill = sale_buyer_name)) +
    scale_fill_discrete(na.value = "white")+

  theme_void() + 
  theme(legend.position = "none")
```

There are `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(keypin) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on sales data.


### Board of Review

```{r}
#| label: fig-Berwyn-appellantname
#| fig-cap: "Mapped by Board of Review Appellant name."
#| layout-ncol: 2

# 
# parcel_comparison <- left_join(parcels, bor_pins) %>% 
#   select(group, pin10, appellant, everything()) 
#write_csv(parcel_comparison, "Output/projects_berwyn.csv")

parcel_comparison %>% 
  as.data.frame() |>
  group_by(appellant) %>%
  summarize(pins_ingroup = n(), 
            incent_pins = sum(incent_prop==1))

parcel_comparison %>% 
  group_by(appellant) %>%
  mutate(pins_ingroup = n()) %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(appellant))) +
  theme_minimal() + 
  scale_fill_discrete(na.value = "white") + 
  theme(legend.position = "none")

```

There are `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> filter(pins_ingroup > 1) |> n_distinct())` projects with more than 1 pin in them and  `r paste(parcel_comparison %>% group_by(appellant) %>% summarize(pins_ingroup = n()) |> n_distinct())` projects overall based on appeals data.




