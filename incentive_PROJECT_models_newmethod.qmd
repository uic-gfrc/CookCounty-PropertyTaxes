---
title: "Incentive PROJECT Models"
date: "August 10, 2024"
date-modified: last-modified
format: 
  html:
    embed-resources: true
    theme: lumen
    code-fold: true
    code-line-numbers: true
    code-overflow: wrap
    toc: true
    toc-location: left
    df-print: paged
knitr: 
  opts_chunk:
    warning: true
    message: false
---

## Data prep

```{r warning = FALSE}
library(tidyverse)
#library(jsonlite)
#library(httr)
library(fixest)
```


```{r warning = FALSE}
project_pins <- readxl::read_xlsx("./Output/projects_checked_MAINFILE.xlsx")

ptax_pins <- read_csv("./Output/comm_ind_PINs_2011to2022_timeseries.csv") |> 
  filter(year >= 2011)


ptax_proj <- ptax_pins %>% 
  left_join(project_pins, by = c("pin"), relationship = "many-to-many") |>
  rename(Triad = Triad.x,
         clean_name = clean_name.x,
         incent_prop = incent_prop.x) |>
  select(-c(Triad.y, clean_name.y, incent_prop.y,))
```




```{r}
# modelsummary::datasummary_skim(ptax_proj)
```


**Which came first: The TIF or the incentive class??**

```{r}
#| label: tbl-whichcamefirst
#| tbl-cap: "PINS that were in a TIF before receiving an incentive classification. 284 PINs had incentive classes before they were in a TIF. 1534 PINs were in a TIF before they had an incentive classification"

change_table <- ptax_proj |>
  ungroup() |>
  arrange(pin, year) |>
  group_by(pin) |>
  summarize(first_tif_year = first(year[in_tif==1]),
            first_incent_year = first(year[incent_prop=="Incentive"])) |>
  filter(!is.na(first_tif_year) & !is.na(first_incent_year)) |>
  select(pin, first_tif_year, first_incent_year)|> 
  distinct() 

# 284 PINs had incentive classes before they were in a TIF
# change_table |> filter(first_tif_year > first_incent_year)

# 1534 PINs were in a TIF before they had an incentive classification
change_table |> filter(first_tif_year < first_incent_year)



```


```{r}
#| label: tbl-keypin-tiforincent
#| tbl-cap: "Projects that were in a TIF before they also got an incentive classification. 161 projects had an incentive classification before it was in a TIF. 414 projects were in a TIF before they had incentive classification."


change_table <- ptax_proj |>
  ungroup() |> 
  arrange(pin, year) |> 
  group_by(main_keypin) |>
  summarize(first_tif_year = first(year[in_tif==1]),
            first_incent_year = first(year[incent_prop=="Incentive"])) |>
  filter(!is.na(first_tif_year) & !is.na(first_incent_year)) |>
  select(main_keypin, first_tif_year, first_incent_year)|> 
  distinct() 

# 161 projects were in a tif
change_table |> filter(first_tif_year > first_incent_year) 
# 414 projects were in a TIF before they received incentive classes
change_table |> filter(first_tif_year < first_incent_year) 

```


**How many Commercial PINs become Industrial PINs? If commercial pins are the comparison group, we should know the sample size of PINs that change to other land uses.**

```{r}
#| label: tbl-commercial-toOther-pins
#| tbl-cap: "Commercial PINs that became Industrial or other land use types"
#| eval: false
#| include: false

change_table <- ptax_proj |>
  ungroup() |>
  arrange(pin, year) |>
  group_by(pin) |>
  summarize(
    first_commerc_year = first(year[land_use == "Commercial"]),
    first_indust_year = first(year[land_use == "Industrial"]),
    first_other_year = first(year[!land_use %in% c("Commercial", "Industrial")]))  |>
  select(pin, first_commerc_year, first_indust_year, first_other_year)|> 
  distinct() 

# 864 became industrial
change_table |> filter(first_commerc_year < first_indust_year)
  
# 7154
change_table |> filter(first_commerc_year < first_other_year)
```


```{r }
#| label: tbl-keypinchange
#| tbl-cap: "Projects where the first year is a commercial use and then it becomes something else."


change_table <- ptax_proj |>
  ungroup() |>
  arrange(pin, year) |>
  group_by(main_keypin, appellant) |>
  summarize(
    first_commerc_year = first(year[land_use == "Commercial"]),
    first_indust_year = first(year[land_use == "Industrial"]),
    first_other_year = first(year[!land_use %in% c("Commercial", "Industrial")])) |>
  select(appellant, main_keypin, first_commerc_year, first_indust_year, first_other_year)|> 
  distinct() 

#2492 
change_table |> filter(first_commerc_year < first_other_year)
  
# 416
change_table |> filter(first_commerc_year < first_indust_year)


```

```{r}
# ptax_proj %>% 
#   arrange(pin, year) %>%
#  # select(-c(landuse_change, land_use, incent_change, tif_change, pin_classes_2011, pin_classes_2022) ) %>%
#   filter(incent_change %in% c("Always Incentive", "Changes Sometime")) %>%
#            write_csv("Output/incentive_project_summaries.csv")
```



```{r}
ptax_proj_summs <- ptax_proj %>% 
 # left_join(project_pins, by = "pin") |>
  filter(!is.na(main_keypin)) |>
 # mutate(main_keypin = ifelse(is.na(main_keypin), pin, main_keypin) ) |>
  
  group_by(year, main_keypin) %>%
  summarize(
    incent_pins = sum(ifelse(class_ptaxsim >= 600 & class_ptaxsim < 900, 1, 0)),
    n_pins_commerc = sum(land_use == "Commercial"),
    n_pins_indust = sum(land_use == "Industrial"),
    n_pins_land = sum(land_use == "Land"),

    project_pins = n(),
    fmv = sum(fmv, na.rm=TRUE),
    tax_code = mean(tax_code_num, na.rm=TRUE),
    in_tif = mean(in_tif, na.rm=TRUE),
    # pin_classes = paste(sort(unique(class)), collapse = ", "),
  #  land_use = paste(sort(unique(land_use)), collapse = ", "),
    #incent_prop = paste(sort(unique(incent_prop)), collapse = ", "),
    triad = first(Triad),
    clean_name = first(clean_name),
    reassessed_year = first(reassessed_year),
    exe_abate = sum(exe_abate, na.rm = TRUE),
   
   # landuse_change= paste(sort(unique(landuse_change)), collapse = ", "),
   # incent_change = paste(sort(unique(incent_change)), collapse = ", "),
    #tif_change = paste(sort(unique(tif_change)), collapse = ", "),
    av_mailed = sum(av_mailed, na.rm=TRUE),
    av_clerk = sum(av_clerk, na.rm=TRUE) 
    )  %>%
   ungroup() |>
  mutate(
    pct_incent = incent_pins / project_pins,
    pct_commerc = n_pins_commerc / project_pins,
    pct_indust = n_pins_indust / project_pins,
    pct_land = n_pins_land / project_pins,
    incent_prop2 = ifelse(pct_incent > 0, "Incentive", "0"),
    land_use2 = case_when(
      pct_commerc > 0 ~ "Commercial",
      pct_indust > 0 ~ "Industrial",
      pct_land > 0.8 ~ "Land",
      TRUE ~ "Other"
    ))

```


```{r}
table(ptax_proj_summs$land_use2)

timespan = 12 

#ggplot(ptax_proj_summs) + geom_point(aes(x=pct_incent, y = pct_commerc))

#ggplot(ptax_proj_summs) + geom_point(aes(x=pct_incent, y = pct_indust))

ptax_proj_summs <- ptax_proj_summs %>%
  
  group_by(main_keypin) |>
  mutate(
    years_existed = n(),
    # commenting out just to make it run faster
    # but maybe interesting for looking at types of PINs included in a project
   # pin_classes_2011 = ifelse(years_existed == timespan, pin_classes[year == 2011], NA),
    #pin_classes_2022 = ifelse(years_existed == timespan, pin_classes[year == 2022], NA),
    base_year_fmv_2011 = ifelse(years_existed == timespan, 
                                fmv[year == 2011], NA),
    end_year_fmv_2022 = ifelse(years_existed == timespan, fmv[year == 2022], NA),
    fmv_2022_2011_diff = ifelse(!is.na(end_year_fmv_2022) & !is.na(base_year_fmv_2011), end_year_fmv_2022 - base_year_fmv_2011, NA)
  ) %>% 
  ungroup() %>%
  mutate(fmv_growth_2011 = fmv/base_year_fmv_2011) |>
  group_by(year) %>%
  mutate(fmv_w = DescTools::Winsorize(fmv, quantile(fmv, probs = c(0.01, 0.99), na.rm=TRUE)),
         # fmv_growth_2011_w = DescTools::Winsorize(fmv_growth_2011, quantile(fmv_growth_2011, probs = c(0.01, 0.99), na.rm=TRUE)),
         # fmv_2022_2011_diff_w = DescTools::Winsorize(fmv_2022_2011_diff, quantile(fmv_2022_2011_diff, probs = c(0.01, 0.99), na.rm=TRUE)),
         # 
         
       #  base_year_fmv_2006_w =DescTools::Winsorize(base_year_fmv_2006,quantile(base_year_fmv_2006, probs = c(0.01,0.99), na.rm=TRUE)),
  #  fmv_growth_2006_w =DescTools::Winsorize(fmv_growth_2006, quantile(fmv_growth_2006, probs = c(0.01,0.99), na.rm=TRUE)),
    base_year_fmv_2011_w =
      DescTools::Winsorize(base_year_fmv_2011,
                           quantile(base_year_fmv_2011, probs = c(0.01,0.99), na.rm=TRUE)),
    fmv_growth_2011_w =
      DescTools::Winsorize(fmv_growth_2011,
                           quantile(fmv_growth_2011, probs = c(0.01,0.99), na.rm=TRUE))) |>

  ungroup() 

ptax_proj_summs <- ptax_proj_summs %>%
  # mutate(
  #   # commented out to make it run faster 
  #   # landuse_change2 = ifelse(landuse_change!= "Always Commercial" & landuse_change != "Always Industrial", "Changes", landuse_change),
  #        land_use2 = ifelse(!land_use %in% c("Commercial", "Industrial", "Land", "Exempt"), "Multi Land Uses", land_use),
  #        # tif_change2 = ifelse(!tif_change %in% c("Always TIF", "Never TIF"), "Changes", tif_change),
  #       #  incent_change2 = ifelse(!incent_change %in% c("Always Incentive", "Never Incentive"), "Changes", incent_change),
  #    #    in_tif2 = ifelse(in_tif != 0 & in_tif != 1, "Partly in TIF", in_tif)
  #       ) %>%
  mutate(across(c(fmv, tax_code), round, digits = 0))    %>% 
  
  # makes it a balanced panel. Drops all observations that did not exist 12 years
  filter(years_existed == 12) 


```


```{r eval=FALSE, include = FALSE}
ptax_proj_summs %>% 
 # select(-c(landuse_change, land_use, incent_change) ) %>%
           write_csv("Output/Pin to Project Files/project_summaries_2025_Nov15.csv")

```


```{r eval=FALSE}
# ptax_proj_summs %>% is.finite() %>% modelsummary::datasummary_skim()

ptax_proj_summs %>% 
#  select(-c(land_use, incent_prop, landuse_change, tif_change, incent_change)) %>% 
  modelsummary::datasummary_skim()

```


```{r}
#| label: tbl-exemptprojects
#| tbl-cap: Projects that were exempt or became exempt.

summary(ptax_proj_summs$fmv_growth_2011)
summary(ptax_proj_summs$fmv_growth_2011_w)

ptax_proj_summs %>% filter(is.na(fmv_growth_2011))

exempt_anyyear <- ptax_proj_summs %>%
  filter(fmv == 0) #|> distinct(main_keypin)
# 830 exempt unique projects, 4515 observations,


lowFMV <- ptax_proj_summs %>%
  filter(fmv < 100 & fmv != 0)  # |> distinct(main_keypin)
# 159 unique projects, 1503 observations


# projects exempt in 2011. Cause infinite growth in DV
were_exempt <- ptax_proj_summs %>%
  group_by(main_keypin) |>
  filter(fmv == 0 & year == 2011) |> 
  arrange(desc(fmv), main_keypin)
were_exempt 
# 652 unique projects exempt in 2011

# projects exempt in 2022. Cause DV to be 0. (not the worst thing)
became_exempt <- ptax_proj_summs %>%
  group_by(main_keypin) |>
  filter(fmv == 0 & year == 2022)  |> 
  arrange(desc(fmv), main_keypin)
# 10 projects
became_exempt
```


```{r eval=FALSE}
#write_csv(were_exempt, "./Output/properties_were_exempt2.csv")

#write_csv(became_exempt, "./Output/properties_became_exempt2.csv")
```


```{r}
ptax_proj_summs <- ptax_proj_summs %>% 
  filter(!main_keypin %in% were_exempt$main_keypin) %>% ## creates Infinite growth but these are the observations we do want to examine more for vacant to non-vacant properties.
  filter(!main_keypin %in% became_exempt$main_keypin) %>%
  #filter(!main_keypin %in% exempt_anyyear$main_keypin) %>%
 # filter(!main_keypin %in% lowFMV$main_keypin) %>%
  arrange(desc(fmv), main_keypin)

summary(ptax_proj_summs$fmv_growth_2011)
summary(ptax_proj_summs$fmv_growth_2011_w)

ptax_proj_summs %>% filter(year == 2022) %>%
  summarize(project_count = n_distinct(main_keypin),
            pin_count = sum(project_pins))

```


```{r eval=FALSE}
modelsummary::datasummary_skim(ptax_proj_summs)

ptax_proj_summs %>%  
  select(-c(land_use, incent_prop, landuse_change, tif_change, incent_change)) %>% 
  modelsummary::datasummary_skim("categorical")
```

## Fixed Effect Model using Projects

Create winsorized FMV growth at this stage, after removing properties the properties with infinite growth. Too many properties had Inf or 0's as values for the winsorizing to do anything. 



```{r make-proj-panel, eval = FALSE}
library(dplyr)
proj_panel <- ptax_proj_summs %>% 
    filter(year >= 2012) %>% # drop first year of data when fmv growth is 1
   select(main_keypin, year, fmv, fmv_w,# incent_prop,
          land_use2, #in_tif2, 
          triad, fmv_growth_2011, years_existed,
         base_year_fmv_2011, reassessed_year, incent_pins,
          project_pins, incent_pins, clean_name, fmv_growth_2011_w)  %>% 
  # arrange(main_keypin, year) %>% 
  # 
  # mutate(
  #   incent_prop2= ifelse(incent_prop != "Non-Incentive","Incentive", incent_prop),
  #        land_use2 = as.character(land_use2),
  #       incent_prop2 = factor(incent_prop2, levels= c("Non-Incentive", "Incentive"), labels = c("Non-Incentive", "Incentive"), ordered = TRUE)
  #      )  %>%
  ungroup() |>
  group_by(year) %>%
  mutate(fmv_w = DescTools::Winsorize(fmv, quantile(fmv, probs = c(0.005, 0.995), na.rm=TRUE)),
         fmv_growth_2011_w = DescTools::Winsorize(fmv_growth_2011, quantile(fmv_growth_2011, probs = c(0.005, 0.995), na.rm=TRUE)))

write_rds(proj_panel, file = "Output/proj_panel2.RDS")
```


```{r read-proj-panel}

proj_panel <- read_rds("Output/proj_panel2.RDS")

table(proj_panel$incent_prop2)

summary(proj_panel$fmv_growth_2011)
summary(proj_panel$fmv_growth_2011_w)
# write_csv(proj_panel, "Output/project_panel_summaries_2025Sept8.csv")


proj_panel %>% filter(year == 2022) %>%
  summarize(project_count = n_distinct(main_keypin),
            pin_count = sum(project_pins))
```



```{r}
#| label: tbl-growthcomparison-nonwinsor
#| tbl-cap: "Non-winsorized growth for projects."

models <- list(
  projectlevel_2FE = feols(fmv_growth_2011 ~  land_use2*incent_prop2 | 
                             main_keypin + year, 
                           panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
                           data = proj_panel)
                
)


modelsummary::modelsummary(model = models, output = "flextable",
                           stars = TRUE,
                           gof_omit = "AIC|BIC")
```


```{r }
#| label: tbl-likereport
#| tbl-cap: "Similar to incentive report table."

models <- list(
    reassess_year = feols(fmv_growth_2011_w ~ land_use2 | 
                          main_keypin  + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),

  reassess_year = feols(fmv_growth_2011_w ~ land_use2 + incent_prop2 | 
                          main_keypin  + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),

  reassess_year = feols(fmv_growth_2011_w ~ land_use2*incent_prop2 | 
                          main_keypin  + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),
      reassess_year = feols(fmv_growth_2011_w ~ land_use2 | 
                          clean_name  + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),

  reassess_year = feols(fmv_growth_2011_w ~ land_use2 + incent_prop2 | 
                          clean_name + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),

  reassess_year = feols(fmv_growth_2011_w ~ land_use2*incent_prop2 | 
                           clean_name + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel)


)



modelsummary::modelsummary(model = models, 
                           output = "flextable", 
                          stars = TRUE,
                           gof_omit = "AIC|BIC")
```


### With Reassessment interactions or Triad FE

```{r }
#| label: tbl-winsorized-reassessed
#| tbl-cap: "With reassessment years interaction with Winsorized FMV Growth"

models <- list(
  reassess_year = feols(fmv_growth_2011_w ~ land_use2*incent_prop2  + reassessed_year | 
                          main_keypin + clean_name + year, 
                        panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
data = proj_panel),
  
  reassess_interact = feols(fmv_growth_2011_w ~  land_use2*incent_prop2 + reassessed_year*incent_prop2 |
                              main_keypin  + year, 
                            panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
  data = proj_panel),
  
   triadFE1 = feols(fmv_growth_2011_w ~ land_use2*incent_prop2  + reassessed_year | 
                      main_keypin + year^triad, 
                    panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
 data = proj_panel),
  
  triadFE2 = feols(fmv_growth_2011_w ~  land_use2*incent_prop2 + reassessed_year*incent_prop2 |
                     main_keypin + year^triad, 
                   panel.id = c("main_keypin", "year"),                                    
                        vcov = ~clean_name,
  data = proj_panel)
)



modelsummary::modelsummary(model = models, 
                           output = "flextable", 
                          stars = TRUE,
                           gof_omit = "AIC|BIC")
```


```{r }
#| label: tbl-nonwinsorized-reassessed
#| tbl-cap: "With reassessment years interaction with FMV Growth"

models <- list(
  reassess_year = feols(fmv_growth_2011 ~ land_use2*incent_prop2  + reassessed_year | 
                          main_keypin  + year, 
                        panel.id = c("main_keypin", "year"),                                    
                        vcov = ~clean_name,
                        data = proj_panel),
  
  reassess_interact = feols(fmv_growth_2011 ~  land_use2*incent_prop2 + reassessed_year*incent_prop2 | 
                              main_keypin + year, 
                            panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
                            data = proj_panel),
  
   triadFE1 = feols(fmv_growth_2011 ~ land_use2*incent_prop2  + reassessed_year | main_keypin + year, panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
                    data = proj_panel),
  
  triadFE2 = feols(fmv_growth_2011 ~  land_use2*incent_prop2 + reassessed_year*incent_prop2 | 
                     main_keypin + year^triad, 
                   panel.id = c("main_keypin", "year"),                                     
                        vcov = ~clean_name,
                   data = proj_panel)
)



modelsummary::modelsummary(model = models, 
                           output = "flextable", 
                          stars = TRUE,
                           gof_omit = "AIC|BIC")
```


