---
title: "Models for Circulation - Updated after Circulation"
author: "MVH & AWM"
date: 8/17/24
date-modified: last-modified
date-format: long
format: 
  html:
    code-fold: true
    toc: true
    toc-location: left
    tbl-cap-location: top
    fig-cap-location: top
    df-print: paged
---
# Data Prep
```{r setup}
#| output: false

options(scipen = 999, digits = 4) #no scientific notation

# Load packages

library(tidyverse)
library(glue)
library(fixest)
library(modelsummary)
library(tinytable)
library(sandwich)
library(tinytex)
```


```{r recodedata}
# comm_ind <- read_csv("./Output/comm_ind_PINs_2011-2022_balanced.csv")
comm_ind <- read_csv("./Output/comm_ind_PINs_2006to2022_timeseries.csv") |>
  filter(year >= 2011) |>
      
  # set reference levels
  mutate(incent_change = as.factor(incent_change),
         landuse_change = as.factor(landuse_change),
         triad = as.factor(Triad),
         in_tif = as.factor(in_tif),
         land_use = as.factor(land_use),
         incent_prop = as.factor(incent_prop),
         clean_name = as.factor(clean_name), 
         incent_change = relevel(incent_change, ref = "Never Incentive"),
         landuse_change = relevel(landuse_change, ref = "Always Commercial"),
         incent_prop = relevel(incent_prop, ref = "Non-Incentive"),
         triad = relevel(triad, ref = "City"),
         land_use = relevel(land_use, ref = "Commercial"))

# has binary variable for if it was a reassessment year or not. 
# Manually created based on the 3 year rotation used for reassessments.
reassessment_years <- read_csv("./Necessary_Files/Triad_reassessment_years.csv") 


reassessments_long <- reassessment_years %>% 
  pivot_longer(cols = c(`2006`:`2022`), names_to = "year", values_to = "reassessed_year")

land <- c(100, 180, 190, 192, 193, 500, 550, 637, 650, 651, 700, 742, 800, 850, 900)

building <- c(201: 221, 225:236, 278:299, 301:399,401, 417:499, 501:549, 551:599, 638, 654:693, 701:735, 743:799, 800:835, 851:899, 901:999)

vacant = c(100:199)

business_land = c(400, 500, 550, 637, 650, 651, 700, 742, 800, 850)


```


```{r}
table(comm_ind$first_incent_year)
table(comm_ind$next_reassessment)
table(comm_ind$year, comm_ind$next_reassessment)
```


```{r}

comm_ind <- comm_ind |> 
  mutate(building = ifelse(class %in% building, 1, 0),
         nonvacant = ifelse(class %in% vacant, 0, 1)) %>%
  group_by(pin) %>% 
  arrange(year) %>%
  mutate(building_lag = lag(building),
         nonvacant_lag = lag(nonvacant))

#comm_ind_temp <- comm_ind_temp |> 
comm_ind_temp <- comm_ind |> 

  select(pin, class, year, clean_name, treatment_year, status,
         incent_prop, base_year_fmv_2011, base_year_fmv_2006, 
         base_year_fmv_2006_w,fmv_growth_2006_w,
         land_use, major_class_code, landuse_change, incent_change, triad, 
         reassess_lag, reassessed_year, building, nonvacant,
         fmv_growth_2011_w, base_year_fmv_2011_w, first_incent_year,
         in_tif)

comm_ind_df <- comm_ind_temp
```

**How many properties LOSE their incentives?**


```{r}
table(comm_ind_df$year)

table(comm_ind_df$incent_change)

table(comm_ind_df$status)
```

```{r}
comm_ind %>% 
  filter(year == 2022) %>% 
  group_by(building) %>% 
  summarize(n=n())
```


**Figure out how to code something that would represent this situation and allow us to model it:** 

The treatment is having the class of property go from a non-incentive class to an incentive class. Need to consider if it is a reassessment year or not. If it is not a reassessment year, then the class change should result in a change in AV that comes purely from the change in the level of assessment (25% to 10%).  If it is a reassessment year, then the change in value is due to the change in level of assessment and the change in the FMV of the property due to local property trends.  

- We still have the mailed_av that is then appealed by the incentive property which should only reflect the change in market trends since CCAO is removed from the incentive process and the board of appeals is the one that changes the property class. The mailed_av and the clerk_av should still have the same proportion of change in the the AV from the level of assessment (25% to 10%).   

- After a property gets its class changed to an incentive class, how does its fair market value change in the **next assessment cycle** compared to properties that did not get an incentive class?  

- some kind of difference-in-differences design   



> DV for all regressions: FMV growth since 2011

# OLS - Multi-year with Muni and Year Controls


```{r}

ols_models <- list(
    "Year Controls" = lm(fmv_growth_2011_w ~ incent_prop*land_use + year,
                data = comm_ind_df),
  
  "Pooled OLS - Year & City Controls" = lm(fmv_growth_2011_w ~ incent_prop*land_use
             + clean_name + year,
                data = comm_ind_df))


modelsummary(ols_models,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             coef_omit= 'clean_name|year',
             gof_omit = "AIC|BIC|Log.Lik.", output = "flextable")

```


```{r} 
#| label: tbl-reassessinteractwithstatus
#| tbl-cap: "Interaction between status (pre and post treatment) and assessment year (0 or 1) plus year FE and then year and city FE."
#| eval: false
#| include: false

ols_models <- list(
    "Year Controls" = lm(fmv_growth_2011_w ~  reassessed_year*status + year,
                data = comm_ind_df),
  
  "Year and Muni Controls" = lm(fmv_growth_2011_w ~ reassessed_year*status +
             + clean_name + year,
                data = comm_ind_df))


modelsummary(ols_models,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             coef_omit= 'clean_name|year',
             gof_omit = "AIC|BIC|Log.Lik.") #|>  theme_tt("grid")

```

# Logit Models

```{r}
#| label: tbl-logitincentDV
#| tbl-cap: "DV is if a parcel has a incentive property or not or not. 0 = did not have incnetive class, 1 = had incentive class"

comm_ind_df <- comm_ind_df %>% 
  mutate(incent_indicator = ifelse(incent_prop == "Incentive", 1, 0))

models <- list(
  "Land Use"  = feglm(incent_indicator ~ land_use | pin + clean_name + year,
                              panel.id = c("pin", "year"),   
                              data = comm_ind_df, 
                              family = binomial(link = "logit"),
                              vcov = ~ pin + year),
  
  "Land Use andFMV Growth" =  feglm(incent_indicator ~ land_use + fmv_growth_2011_w | pin + clean_name + year,
                                           panel.id = c("pin", "year"),   
                                           data = comm_ind_df, 
                                           family = binomial(link = "logit"),
                                           vcov = ~ pin + year),
  
  "Land Use Interact FMV" = feglm(incent_indicator ~ land_use*fmv_growth_2011_w | pin + clean_name + year,
                                    panel.id = c("pin", "year"),   
                                    data = comm_ind_df, 
                                    family = binomial(link = "logit"),
                                    vcov = ~ pin + year)
)

modelsummary(models, stars = TRUE, output = "flextable")
```

```{r }
#| label: tbl-logit-buildingDV
#| tbl-cap: "DV is if a parcel has a building or not. 0 = no building, 1 = building."

comm_ind_df <- comm_ind_df %>% 
  mutate(land_use = relevel(land_use, ref = "Land"))

models <- list(
    "By Incent Prop" = fixest::feglm(building ~ incent_prop | pin + clean_name + year,
                                    panel.id = c("pin", "year"),   
                                    data = comm_ind_df, 
                                    family = binomial(link = "logit"),
                                    vcov = ~ pin),
    
     "By Incent&Use" = fixest::feglm(building ~ incent_prop + land_use | pin + clean_name + year,
                                    panel.id = c("pin", "year"),   
                                    data = comm_ind_df, 
                                    family = binomial(link = "logit"),
                                    vcov = ~ pin),
    
  "By Land Use"  = fixest::feglm(building ~ land_use | pin + clean_name + year,
                              panel.id = c("pin", "year"),   
                              data = comm_ind_df, 
                              family = binomial(link = "logit"),
                              vcov = ~ pin ),
  
  "Land Use and\nFMV Growth" = fixest::feglm(building ~ incent_prop + land_use + fmv_growth_2011_w | pin + clean_name + year,
                                           panel.id = c("pin", "year"),   
                                           data = comm_ind_df, 
                                           family = binomial(link = "logit"),
                                           vcov = ~ pin),
  
  "Land Use \nInteract FMV" = fixest::feglm(building ~ land_use*incent_prop | pin + clean_name + year,
                                    panel.id = c("pin", "year"),   
                                    data = comm_ind_df, 
                                    family = binomial(link = "logit"),
                                    vcov = ~ pin)
  
)

modelsummary(models, stars = TRUE, output = "flextable", gof_omit = "AIC|BIC")
```


# Fixed Effect Models

## Model Notes

**StandardErrors **   
"For clustering with fixed effects to be necessary (and a good idea), several conditions need to hold. First, there needs to be treatment effect heterogeneity. That is, the treatment effect must be quite different for different individuals.

If that is true, there’s a second condition. Either the fixed effect groups/individuals in your data need to be a non-random sampling of the population. That is, some groups are more likely to be included in your sample than others. or, within fixed effect groups/individuals, your treatment variable is assigned in a clustered way. For example, with city fixed effects, are certain individuals in that city more likely to be treated than others?

So before clustering, think about whether both conditions are likely to be true. If it is, go ahead and cluster! If not, don’t bother, as the clustering will make your standard errors larger than they’re supposed to be." - [The Effect](https://theeffectbook.net/ch-FixedEffects.html) 

**Misc. Defintions**   
- Conditional Average Treatment Effect. The average treatment effect among those with certain values of certain variables (for example, the average treatment effect among women).   
- Average Treatment on the Treated. The average treatment effect among those who actually received the treatment in your study.   


## PIN-level fixed effects - winsorized

```{r pin_fe}

comm_ind_df <- comm_ind_df %>% 
  mutate(land_use = relevel(land_use, ref = "Commercial"))

pin_fe_models <- list(
  
      "1" = feols(fmv_growth_2011_w ~ land_use 
                  | pin + year,
                       data = comm_ind_df
                       ),
      
      "2" = feols(fmv_growth_2011_w ~ incent_prop + land_use 
                  | pin + year,
                       data = comm_ind_df 
                       ),


      "3" = feols(fmv_growth_2011_w ~ incent_prop*land_use  
                  | pin + year, 
                       data = comm_ind_df 
                       )
                )

modelsummary(pin_fe_models,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             gof_omit = "AIC|BIC|Log.Lik.")

```

```{r pin_withtriadreassess_fe}
#| eval: false
#| include: false 
#| 
pin_fe_models <- list(
  
      "1" = feols(fmv_growth_2011_w ~ land_use 
                  | pin + year + reassessed_year^triad, vcov = "threeway",
                       data = comm_ind_df
                       ),
      
      "2" = feols(fmv_growth_2011_w ~ incent_prop + land_use 
                  | pin + year + reassessed_year^triad, vcov = "threeway",
                       data = comm_ind_df 
                       ),


      "3" = feols(fmv_growth_2011_w ~ incent_prop*land_use  
                  | pin + year + reassessed_year^triad, vcov = "threeway",
                       data = comm_ind_df 
                       )
                )

modelsummary(pin_fe_models,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             gof_omit = "AIC|BIC|Log.Lik.|RMSE")

```


## Muni-Level Fixed Effects - Don't Use!


```{r}
#| warning: false

muni_fe_models <- list(
  
      "1" = feols(fmv_growth_2011_w ~ land_use | clean_name + year,
                   vcov = "twoway",
                       data = comm_ind_df ),
      
      "2" = feols(fmv_growth_2011_w ~ incent_prop + land_use | clean_name + year,
                                     vcov = "twoway",
                       data = comm_ind_df 
                       ),


      "3" = feols(fmv_growth_2011_w ~ incent_prop*land_use | clean_name + year,
                                                       vcov = "twoway",

                       data = comm_ind_df  )
      
                        )

modelsummary(muni_fe_models,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             gof_omit = "AIC|BIC|Log.Lik.", 
             output = "flextable")

```


## Muni and PIN fixed effects

```{r winsorize-muni-pin_fe}
#| warning: false

muni_fe_models <- list(
  
      "One FE" = feols(fmv_growth_2011_w ~ land_use + triad*reassessed_year + 
                   triad*l(reassessed_year, 1:2) 
                  | pin  + year + clean_name ,
                panel.id = c("pin", "year"), 
                       data = comm_ind_df ),
      
      "PIN Muni FE" = feols(fmv_growth_2011_w ~ incent_prop + land_use | pin + clean_name + year,
                        vcov = "twoway", 
                  panel.id = c("pin", "year"),
                       data = comm_ind_df 
                       ),

      "Threeway FE" = feols(fmv_growth_2011_w ~ incent_prop*land_use + reassessed_year + l(reassessed_year, 1) + l(reassessed_year, 2)  | pin  + year + clean_name,
                        vcov = "threeway", 
                  panel.id = c("pin", "year"),
                       data = comm_ind_df  ),
      
          "Pin Year FE" = feols(fmv_growth_2011_w ~ incent_prop*land_use + in_tif | pin + year + clean_name ,
                       vcov = "twoway", 
                      panel.id = c("pin", "year"),
                       data = comm_ind_df ),
      
           "Threeway FE" = feols(fmv_growth_2011_w ~ incent_prop*land_use + in_tif | pin + year  + clean_name ,
                       vcov = "threeway", 
                      panel.id = c("pin", "year"),
                       data = comm_ind_df )
           
                        )

modelsummary(muni_fe_models,
             stars = TRUE,
            # fmt = function(x) round(x, 2),
             coef_omit= 'pin|year|clean_name',
             gof_omit = "AIC|BIC|Log.Lik.", 
            outoupt = "flextable")

```

```{r muni-pin-triadreassess_fe}
#| warning: false
#| eval: false
#| include: false

muni_fe_models <- list(
  
      "1" = feols(fmv_growth_2011_w ~ land_use + triad*reassessed_year + 
                   triad*l(reassessed_year, 1:2) 
                  | pin + clean_name  + triad^year^reassessed_year,
                panel.id = c("pin", "year"), 
                       data = comm_ind_df ),
      
      "2" = feols(fmv_growth_2011_w ~ incent_prop + land_use | pin + triad^year^reassessed_year + clean_name,
                       vcov = "threeway", 
                  panel.id = c("pin", "year"),
                       data = comm_ind_df 
                       ),

      "3" = feols(fmv_growth_2011_w ~ incent_prop*land_use + reassessed_year + l(reassessed_year, 1) + l(reassessed_year, 2)  | pin  + triad^year^reassessed_year + clean_name,
                        vcov = "threeway", 
                  panel.id = c("pin", "year"),
                       data = comm_ind_df  ),
      
          "4" = feols(fmv_growth_2011_w ~ incent_prop*land_use + in_tif | pin + triad^year^reassessed_year + clean_name ,
                       vcov = "threeway", 
                      panel.id = c("pin", "year"),
                       data = comm_ind_df )
                        )

modelsummary(muni_fe_models,
             stars = TRUE,
            # fmt = function(x) round(x, 2),
             coef_omit= 'pin|year|clean_name',
             gof_omit = "AIC|BIC|Log.Lik.|RMSE")

```


# Commercial VS Industrial Models

The industrial subset keeps a property (all years) if they were industrial property at any point in time.

The commercial subset keeps a property (all years) if they were commercial property at any point in time.

**Winsorized FMV Growth, Muni and Year Fixed Effects**

Use 3 Fixed Effects  and cluster by PIN & Muni. Not year

Interaction term  between incent_prop * land_use

```{r}
industrial_subset <- comm_ind_df |> 
  group_by(pin) |>
  filter(any(land_use == "Industrial"))

commercial_subset <- comm_ind_df |> 
  group_by(pin) |>
  filter(any(land_use == "Commercial"))


muni_fe_new_vars_mods <- list(
  
  "Industrial- Muni Year FE" = feols(fmv_growth_2011_w ~ land_use*incent_prop + in_tif
                 | clean_name + year,  vcov = "twoway",
                              data = industrial_subset
  ),
    
  "Industrial- PIN, Muni, Year FE" = feols(fmv_growth_2011_w ~ land_use*incent_prop + in_tif
                 | pin + clean_name + year,  vcov = "threeway",
                              data = industrial_subset
  ),

  "Commercial- Muni Year FE" = feols(fmv_growth_2011_w ~ land_use*incent_prop + in_tif
                 | clean_name + year,  vcov = "twoway",
                              data = commercial_subset
  ),
    "Commercial Subset, Muni&PIN FE" = feols(fmv_growth_2011_w ~ land_use*incent_prop + in_tif
                 | pin + clean_name + year,  vcov = "threeway",
                              data = commercial_subset
  )
)
modelsummary(muni_fe_new_vars_mods,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             gof_omit = "AIC|BIC|Log.Lik.|RMSE")
```


**Industrial Subset with Winsorized FMV Growth**

```{r industrial_models}

muni_fe_new_vars_mods <- list(
  
     "Incentive Calass" = feols(fmv_growth_2011_w ~ incent_prop
                 | clean_name + year,  vcov = "twoway",
                 data = industrial_subset
),
     
      "Land Use" = feols(fmv_growth_2011_w ~ relevel(land_use, ref="Industrial")
                 | clean_name + year,  vcov = "twoway",
                 data = industrial_subset
                       ),
      "Pin, Muni, Year FE" = feols(fmv_growth_2011_w ~ incent_prop*relevel(land_use, ref="Industrial") 
                 | pin + clean_name + year,  vcov = "threeway",
                 data = industrial_subset
                       ),
      "Muni Year FE" = feols(fmv_growth_2011_w ~ incent_prop*relevel(land_use, ref="Industrial") 
                 | clean_name + year,  vcov = "twoway",
                 data = industrial_subset
                       )
)

modelsummary(muni_fe_new_vars_mods,
             stars = TRUE,
             fmt = function(x) round(x, 2),
             gof_omit = "AIC|BIC|Log.Lik.|RMSE") 


```

**Commercial Subset with Winsorized FMV Growth**

```{r commercial_models}

muni_fe_new_vars_mods <- list(
  
     "Incentive Class" = feols(fmv_growth_2011_w ~ incent_prop
                 | clean_name + year,  vcov = "twoway",
                 data = commercial_subset
                 ),
      "Land Use" = feols(fmv_growth_2011_w ~ land_use
                 | clean_name + year,  vcov = "twoway",
                 data = commercial_subset
                       ),
      "Muni, Year FE" = feols(fmv_growth_2011_w ~ incent_prop*land_use 
                 | clean_name + year,  vcov = "twoway",
                 data = commercial_subset
                       ),
     
  
        "PIN,Muni,Year FE" = feols(fmv_growth_2011_w ~ incent_prop*land_use
                 | pin + clean_name + year,  vcov = "threeway",
                 data = commercial_subset
                       )
)

modelsummary(muni_fe_new_vars_mods,
             stars = TRUE,
             fmt = function(x) round(x, 2),
            # coef_omit= 'pin|year',
             gof_omit = "AIC|BIC|Log.Lik.|RMSE") #|>  theme_tt("grid")


```

# graphs 

```{r dataexploration}
comm_ind_df |>
  filter(year==2022)|>
  ggplot(aes(fmv_growth_2006_w)) +
  geom_histogram(bins = 100) +
  theme_classic()

comm_ind_df |>
  filter(year==2022)|>
  ggplot(aes(fmv_growth_2011_w)) +
  geom_histogram(bins = 100) +
  theme_classic()

comm_ind_df |>
  select(fmv_growth_2011_w) |>
  ungroup() |>
  summarize(max = max(fmv_growth_2011_w, na.rm = TRUE), 
            min = min(fmv_growth_2011_w, na.rm=TRUE), 
            mean = mean(fmv_growth_2011_w, na.rm = TRUE),
            median = median(fmv_growth_2011_w, na.rm = TRUE), 
            sd= sd(fmv_growth_2011_w, na.rm=TRUE))


# Look at FMV growth
comm_ind_df |> ungroup() |>
      filter(year == 2022)|>
  summarize(min_growth = min(fmv_growth_2011_w, na.rm=TRUE), 
            max_growth = max(fmv_growth_2011_w, na.rm=TRUE), 
            mean_growth = mean(fmv_growth_2011_w, na.rm=TRUE), 
            med_growth = median(fmv_growth_2011_w, na.rm=TRUE),
            sd_growth = sd(fmv_growth_2011_w, na.rm=TRUE))


# Look at base_year_fmv_2011_2
comm_ind_df |> ungroup() |>
    filter(year == 2022)|>
  summarize(min_fmv = min(base_year_fmv_2011_w, na.rm=TRUE), 
            max_fmv = max(base_year_fmv_2011_w, na.rm=TRUE), 
            mean_fmv = mean(base_year_fmv_2011_w, na.rm=TRUE), 
            med_fmv = median(base_year_fmv_2011_w, na.rm=TRUE),
            sd_fmv = sd(base_year_fmv_2011_w, na.rm=TRUE))

comm_ind_df |>
      filter(year == 2021)|>
  ggplot() +
  geom_freqpoly(aes(base_year_fmv_2011_w, color = "FMV in 2011")) +
  labs(
    title = "Distribution of 2011 FMV Values",
    x = "FMV",   y = "n", color = "Legend") +
  theme_classic()

comm_ind_df |>
      filter(year == 2021)|>
  ggplot() +
  geom_freqpoly(aes(fmv_growth_2011_w, color = "FMV Growth since 2011")) +
  labs(
    title = "Distribution of Growth Rates since 2011 (2021 Data)",
    x = "Growth since 2011",   y = "n",
    color = "Legend") +
  theme_classic()

comm_ind_df |>
      filter(year == 2022)|>
  ggplot() +
  geom_point(aes(x = base_year_fmv_2011_w, y = fmv_growth_2011_w, alpha = 0.3, color = land_use)) +
    labs(
    title = "Relationship between 2011 FMV Values and Growth Rates (2022 Data)",
    x = "2011 FMV",    y = "FMV Growth",
    color = "Land Use") +
  theme_classic()


comm_ind_df |>
  filter(year == 2021)|>
  filter(land_use %in% c("Industrial", "Commercial")) |>
  ggplot() +
  geom_point(aes(x = base_year_fmv_2011_w, y = fmv_growth_2011_w, color = land_use, alpha = 0.3)) +
    labs(
    title = "Relationship between 2011 FMV Values and Growth Rates (2022 Data)",
    x = "2011 FMV",
    y = "FMV Growth",
    color = "Land Use") +
  theme_classic()

```
